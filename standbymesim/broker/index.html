<!DOCTYPE html>
<html lang="it-IT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Message Broker Simulator</title>
<script type='text/javascript' src='../js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='../js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link href="../css/site.css" rel="stylesheet">
<link href="../css/bootstrap.css" rel="stylesheet">
</head>
<body>
<div id="main">
<h1 class="intest" >Message Broker Simulator (Database)</h1>
<hr id="hd1">
<div style="float:left; width:50%; padding:10px">
<h5><b>Proximity sensor table</b></hr>
<table class="table-bordered" width="100%">
<tr>
<td class="legenda" width="15%"><i><b>id</i></b></td>
<td class="legenda" width="25%">BT MAC</td>
<td class="legenda" width="25%">WiFi MAC</td>
<td class="legenda" width="10%">status</td>
<td class="legenda" width="25%">timestamp</td>
</tr>
<tr>
<td class="dato" ><span id="id0"></span></td>
<td class="dato" ><span id="bt0"></span></td>
<td class="dato" ><span id="wf0"></span></td>
<td class="dato" ><span id="st0"></span></td>
<td class="dato" ><span id="ts0"></span></td>
</tr>
<tr>
<tr>
<td class="dato" ><span id="id1"></span></td>
<td class="dato" ><span id="bt1"></span></td>
<td class="dato" ><span id="wf1"></span></td>
<td class="dato" ><span id="st1"></span></td>
<td class="dato" ><span id="ts1"></span></td>
</tr>
<tr>
<td class="dato" ><span id="id2"></span></td>
<td class="dato" ><span id="bt2"></span></td>
<td class="dato" ><span id="wf2"></span></td>
<td class="dato" ><span id="st2"></span></td>
<td class="dato" ><span id="ts2"></span></td>

</tr>
<tr>
<td class="dato" ><span id="id3"></span></td>
<td class="dato" ><span id="bt3"></span></td>
<td class="dato" ><span id="wf3"></span></td>
<td class="dato" ><span id="st3"></span></td>
<td class="dato" ><span id="ts3"></span></td>
</tr>
</table>
</div>
<div id="proxy" >
<!--
<table class="table-bordered" width="100%">
<tr><td class="legenda" width="25%">MY MAC</td><td class="legenda" width="25%">OTH MAC</td> <td class="legenda" width="25%">TIMESTAMP</td> <td class="legenda" width="25%">STATUS</td> </tr> 
<tr><td>x</td><td>x</td> <td>x</td> <td>x</td> </tr> 
<tr><td>x</td><td>x</td> <td>x</td> <td>x</td> </tr> 
<tr><td>x</td><td>x</td> <td>x</td> <td>x</td> </tr> 
</table>
-->
</div>
<div style="clear:left"></div>
<div style="float:clear">
<hr >
<b>../api/simupdproxy.php?mything=<select name="myth" id="myth">
<option value="240ac4623d6a">1(240ac4623d6a)</option>
<option value="240ac462411a">2(240ac462411a)</option>
<option value="fcf5c42e1cca">3(fcf5c42e1cca)</option>
<option value="fcf5c42f303e">4(fcf5c42f303e)</option>
</select>&otherthing=<select name="otherth" id="otherth">
<option value="240ac4623d6a">1(240ac4623d6a)</option>
<option value="240ac462411a">2(240ac462411a)</option>
<option value="fcf5c42e1cca">3(fcf5c42e1cca)</option>
<option value="fcf5c42f303e">4(fcf5c42f303e)</option>
</select>&status=<select name="sta" id="sta">
<option value="0">0</option>
<option value="1">1</option>
</select>
<input type="button" value="Send proxy info" onClick="sendproxy()"></b><br><br>
<hr id="hd1">
<h5 ><i>REQUEST:</i><span id="rq">?</span></h5>
<h5><i>RESPONSE:</i><span id="rs">?</span></h5>
<!-- <h5><i>SSE:</i><span id="sse">?</span></h5> -->
<hr id="hd1">
<div id="contenitore"><p class="doc">This web page shows, in real time, the status of the four proximity sensor devices and the history of alert events as they are known by the message broker. <br>
The changes status of the sensor are determined by the peripheral devices (microcontrolled proximity sensors) by means of the "simupdproxy" API called by Real Time Proximity Sensor Simulator page. Each proximity event generates at least two event generated by two devices<br>
The history of events is updated at each new event by means of simgetproxy API.<br>
Simulator can force the change of state of each device  sending "simudpproxy" API requests (one single event for each call).<br></p></div>
</div>
</div>
</body>
</html>
<script type="text/javascript">
var interval = setInterval(getall, 500);
//getproxy();
var source = new EventSource('../api/simsseproxy.php');
source.addEventListener('message', function(event) {
  var data = JSON.parse(event.data);
  var numrow=data.numrow;
  //jQuery('#sse').html(numrow);
  var ptab='<h5><b>Proxy events table: '+numrow+' elements</b></hr>';
  ptab+='<table class="table-bordered" width="100%"><tr><td class="legenda" width="25%">MY MAC</td><td class="legenda" width="25%">OTH MAC</td> <td class="legenda" width="25%">TIMESTAMP</td> <td class="legenda" width="25%">STATUS</td></tr>';
  var events=data.events;
  if (typeof events === "undefined") {
	ptab+='</table>';
  }
  else {
	var i=0;
	events.forEach(function(t){
		ptab+='<tr><td class="dato">'+t.mybtmac+'</td><td class="dato">'+t.otherbtmac+'</td><td class="dato">'+t.timestamp+'</td><td class="dato">'+t.status+'</td></tr>';
		i++;
	});
	ptab+='</table>';
  }
 jQuery('#proxy').html(ptab);
}, false);

function getall() {
	//build request URL
	var req="../api/simgetall.php";
	//local diagnostic of request URL
	//jQuery('#rq').html(req);
	//update local diagnostic of status
	//send request and wait for response (sycronous)
	jQuery.ajax({
		url: req,
		dataType: 'html',
		success: function (data) {
					//remote diagnostic of response
					//jQuery('#rs').html(data);
					var things = jQuery.parseJSON( data ).data;
					var i=0;
					things.forEach(function(t){
						jQuery('#id'+i).html(t.id);
						jQuery('#bt'+i).html(t.btmac);
						jQuery('#wf'+i).html(t.wifimac);
						jQuery('#st'+i).html(t.status);
						jQuery('#ts'+i).html(t.timestamp);
						i++;
					});
				},
        error: function(){
					//error trap
                    jQuery("#contenitore").html("AJAX error");
                },
		});
}
function sendproxy(){
	//build request URL
	var mything=jQuery('#myth option:selected').val();
	var otherthing=jQuery('#otherth option:selected').val();
	if(mything==otherthing) {
		alert("proxy on same device is not allowed");
		return;
	}
	var sta=jQuery('#sta option:selected').val();
	var req="../api/simupdproxy.php?mything="+mything+"&otherthing="+otherthing+"&status="+sta;
	//local diagnostic of request URL
	jQuery('#rq').html(req);
	//update local diagnostic of status
	//send request and wait for response (sycronous)
	jQuery.ajax({
		url: req,
		dataType: 'html',
		success: function (data) {
					//remote diagnostic of response
					jQuery('#rs').html(data);
                },
                error: function(){
						//error trap
                    jQuery("#contenitore").html("AJAX error");
                },
		});
}
/*
function getproxy() {
	//build request URL
	var req="../api/simgetproxy.php";
	//local diagnostic of request URL
	//jQuery('#rq').html(req);
	//update local diagnostic of status
	//send request and wait for response (sycronous)
	jQuery.ajax({
		url: req,
		dataType: 'html',
		success: function (data) {
					//remote diagnostic of response
					//jQuery('#rs').html(data);
					var ptab='<table class="table-bordered" width="100%"><tr><td class="legenda" width="25%">MY MAC</td><td class="legenda" width="25%">OTH MAC</td> <td class="legenda" width="25%">TIMESTAMP</td> <td class="legenda" width="25%">STATUS</td></tr>';
					var proxy = jQuery.parseJSON( data ).data;
					var i=0;
					proxy.forEach(function(t){
						ptab+='<tr><td class="dato">'+t.mybtmac+'</td><td class="dato">'+t.otherbtmac+'</td><td class="dato">'+t.timestamp+'</td><td class="dato">'+t.status+'</td></tr>';
						i++;
					});
					ptab+='</table>';
					jQuery('#proxy').append(ptab);
				},
        error: function(){
					//error trap
                    jQuery("#contenitore").html("AJAX error");
                },
		});
}
*/
</script>
